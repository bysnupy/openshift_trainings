---
- name: OpenShift Pre-Installation tasks
  hosts: "{{ host }}"
  vars:
    disable_repos:
      "rhel-7-server-htb-rpms,rhel-7-server-rt-beta-rpms"
    required_repos:
      - rhel-7-server-rpms
      - rhel-7-server-extras-rpms

  roles:
  #- { role: disable_packages, disabled_packages: ['firewalld'] }
  #- { role: enable_packages, enabled_packages: ['NetworkManager'] }
  #- { role: rhsm_registration, rh_user: "{{ RHUSER }}", rh_pass: "{{ RHPASS }}", pool_ids: ["{{POOLID}}"] }
  #- { role: created_hosts, target_group_name: "nodes" }
  - { role: set_dns, dns_conn_name: enp0s3, dns4_servers: 192.168.123.103 }
  - { role: set_ntp, ntp_servers: [ console.host.local ] }

  tasks:
  - name: Install the yum-utils for setting up specific yum repositories
    yum:
      name: yum-utils
      state: installed
      disablerepo: "{{ disable_repos }}"

  - name: Listing the enabled repositories at this time
    shell: subscription-manager repos --list-enabled | awk '/Repo ID/{print $3}'
    register: repos_output

  - name: Disable all repositories for adding required ones
    command: yum-config-manager --disable "{{ item }}"
    with_items: "{{ repos_output.stdout_lines }}"

  - name: Adds required repositories for OpenShit installation
    command: yum-config-manager --enable "{{ item }}"
    with_items: "{{ required_repos }}"

  - name: Install required packages
    yum:
      name: "{{ item }}"
      state: installed
    with_items:
      - docker

